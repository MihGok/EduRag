from typing import List, Dict


def build_course_analysis_prompt(topic: str, courses: List[Dict]) -> str:
    """
    Создает промпт для анализа релевантности курсов
    
    Args:
        topic: Тема запроса пользователя
        courses: Список курсов с полями 'id' и 'title'
    
    Returns:
        Промпт для LLM
    """
    # Формируем список курсов
    courses_list = ""
    for idx, course in enumerate(courses, 1):
        courses_list += f"{idx}. [ID: {course.get('id')}] {course.get('title')}\n"
    
    prompt = f"""Ты — эксперт-аналитик образовательных программ. 

ЗАДАЧА: Оценить релевантность курсов Stepik для темы: "{topic}"

ВХОДНЫЕ ДАННЫЕ:
У тебя есть только названия курсов. Для каждого курса нужно:
1. Сгенерировать краткое описание того, чему скорее всего учит этот курс (reasoning)
2. Выставить оценку релевантности теме "{topic}" от 0 до 10 (course_score)

ШКАЛА ОЦЕНОК:
- 9-10: Курс полностью посвящен указанной теме, охватывает все ключевые аспекты
- 7-8:  Курс в основном посвящен теме, но может включать дополнительные разделы
- 5-6:  Курс частично релевантен, тема является одним из разделов
- 3-4:  Тема упоминается косвенно или является вспомогательной
- 0-2:  Курс не релевантен или содержит только вводную информацию

СПИСОК КУРСОВ ДЛЯ АНАЛИЗА:
{courses_list}

ФОРМАТ ВЫВОДА:
Верни результат СТРОГО в формате JSON-массива из {len(courses)} объектов.
Каждый объект должен содержать: course_id, course_title, reasoning, course_score.

НЕ ДОБАВЛЯЙ никаких пояснений до или после JSON.
"""
    
    return prompt.strip()


def build_lesson_analysis_prompt(topic: str, course_title: str, lessons: List[Dict]) -> str:
    """
    Создает промпт для анализа релевантности уроков курса
    
    Args:
        topic: Тема запроса пользователя
        course_title: Название курса
        lessons: Список уроков с полями 'lesson_id' и 'title'
    
    Returns:
        Промпт для LLM
    """
    # Формируем список уроков
    lessons_list = ""
    for idx, lesson in enumerate(lessons, 1):
        lessons_list += f"{idx}. [ID: {lesson['lesson_id']}] {lesson['title']}\n"
    
    prompt = f"""Ты — методист онлайн-образования со специализацией в курировании учебных программ.

КОНТЕКСТ:
Пользователь изучает тему: "{topic}"
Он выбрал курс: "{course_title}"

ЗАДАЧА:
Оценить релевантность КАЖДОГО УРОКА для эффективного изучения темы "{topic}".
Учитывай:
- Насколько урок важен для понимания ключевых концепций темы
- Является ли урок практическим применением теории
- Содержит ли урок уникальный контент, которого нет в других уроках

ШКАЛА ОЦЕНОК (0-10):
- 9-10: КРИТИЧЕСКИ ВАЖЕН — без этого урока невозможно полноценное понимание темы
        Примеры: основные алгоритмы, ключевые концепции, обязательная практика
        
- 7-8:  ОЧЕНЬ ПОЛЕЗЕН — рекомендуется для глубокого изучения
        Примеры: продвинутые техники, важные паттерны, полезные инструменты
        
- 5-6:  МОЖЕТ БЫТЬ ПОЛЕЗЕН — дополнительный материал для расширения знаний
        Примеры: альтернативные подходы, дополнительные библиотеки, примеры использования
        
- 3-4:  КОСВЕННО СВЯЗАН — периферийная информация
        Примеры: общий контекст, история развития, смежные технологии
        
- 0-2:  НЕ РЕЛЕВАНТЕН или ВВОДНЫЙ — можно пропустить без потери ценности
        Примеры: приветствие, общие слова, офф-топик контент

СПИСОК УРОКОВ:
{lessons_list}

ФОРМАТ ВЫВОДА:
Верни JSON с оценками для ВСЕХ {len(lessons)} уроков.
Каждый объект должен содержать: lesson_id, lesson_title, lesson_score, reasoning.

НЕ ДОБАВЛЯЙ никаких пояснений до или после JSON.
"""
    return prompt.strip()


def build_course_filter_prompt(query: str, courses_list: str) -> str:
    """
    Промпт для фильтрации курсов (строгий отбор)
    
    Args:
        query: Поисковый запрос пользователя
        courses_list: Форматированный список курсов
    
    Returns:
        Промпт для LLM
    """
    prompt = f"""Ты — опытный методист и аналитик образовательных программ.

ЗАПРОС ПОЛЬЗОВАТЕЛЯ: "{query}"

ЗАДАЧА:
Отфильтровать список найденных курсов, оставив ТОЛЬКО те, которые:
1. ГЛУБОКО посвящены теме "{query}"
2. Являются полноценными обучающими курсами (не тесты, не спам)
3. Имеют конкретное содержание (не "Введение во всё на свете")

ИСКЛЮЧИ:
- Общие курсы, если тема специфична
- Курсы-пустышки, тесты, демо-версии
- Курсы, где тема упоминается только вскользь

СПИСОК КАНДИДАТОВ:
{courses_list}

ФОРМАТ ВЫВОДА:
JSON с полем relevant_ids — массив ID лучших курсов.
"""
    
    return prompt.strip()